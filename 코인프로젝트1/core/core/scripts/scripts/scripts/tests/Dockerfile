################################
# EC2ìš© Docker ì„¤ì • (ìˆ˜ì •ì‚¬í•­ í¬í•¨)
################################

################################
# 1. Dockerfile (EC2 ìµœì í™”)
################################
FROM python:3.11-slim as builder

ARG PYTHON_VERSION=3.11
ARG TIMEZONE=Asia/Seoul

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /build

# EC2ëŠ” apt ë¯¸ëŸ¬ ì„œë²„ê°€ ëŠë¦´ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ í•œêµ­ ë¯¸ëŸ¬ ì‚¬ìš©
RUN sed -i 's/deb.debian.org/ftp.kr.debian.org/g' /etc/apt/sources.list && \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --user --no-warn-script-location -r requirements.txt

FROM python:3.11-slim

LABEL maintainer="your-email@example.com" \
      version="1.0.0" \
      description="Quant Trading System for EC2"

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH="/home/quant/.local/bin:${PATH}" \
    PYTHONPATH="/app:${PYTHONPATH}" \
    TZ=Asia/Seoul

RUN groupadd -r quant && \
    useradd -r -g quant -d /home/quant -s /sbin/nologin -c "Quant user" quant && \
    mkdir -p /home/quant && \
    chown -R quant:quant /home/quant

RUN sed -i 's/deb.debian.org/ftp.kr.debian.org/g' /etc/apt/sources.list && \
    apt-get update && apt-get install -y --no-install-recommends \
    tzdata \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone

WORKDIR /app

COPY --from=builder --chown=quant:quant /root/.local /home/quant/.local
COPY --chown=quant:quant . .

RUN mkdir -p logs data backtest_results && \
    chown -R quant:quant /app && \
    chmod -R 755 /app && \
    chmod +x scripts/docker-entrypoint.sh

HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python scripts/health_check.py || exit 1

USER quant
EXPOSE 8501

ENTRYPOINT ["./scripts/docker-entrypoint.sh"]

################################
# 2. docker-compose.yml (EC2 ìµœì í™”)
################################
version: '3.8'

services:
  quant-trading:
    build:
      context: .
      dockerfile: Dockerfile
    image: quant-trading:latest
    container_name: quant-trading-system
    restart: unless-stopped
    
    environment:
      - TRADING_ENV=production
      - DATABASE_URL=sqlite:///data/quant.db
      - LOG_LEVEL=INFO
    
    volumes:
      # EC2 EBS ë³¼ë¥¨ ë§ˆìš´íŠ¸ ê°€ëŠ¥
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./data:/app/data
    
    # EC2 ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤ì— ë§žê²Œ ì¡°ì •
    deploy:
      resources:
        limits:
          cpus: '1'  # t2.microëŠ” 1 vCPU
          memory: 900M  # t2.microëŠ” 1GB RAM
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # ë¡œê¹… ë“œë¼ì´ë²„ ì„¤ì • (CloudWatch ì—°ë™ ê°€ëŠ¥)
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    image: quant-trading:latest
    container_name: quant-dashboard
    restart: unless-stopped
    command: ["streamlit", "run", "streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    
    ports:
      - "8501:8501"
    
    environment:
      - DATABASE_URL=sqlite:///data/quant.db
    
    volumes:
      - ./data:/app/data:ro
    
    depends_on:
      - quant-trading
    
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 400M

################################
# 3. scripts/ec2-setup.sh (EC2 ì´ˆê¸° ì„¤ì •)
################################
#!/bin/bash
# EC2 ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸

set -e

echo "ðŸš€ EC2 í€€íŠ¸ íŠ¸ë ˆì´ë”© ì‹œìŠ¤í…œ ì„¤ì • ì‹œìž‘..."

# 1. ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
echo "ðŸ“¦ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸..."
sudo apt-get update
sudo apt-get upgrade -y

# 2. Docker ì„¤ì¹˜
echo "ðŸ³ Docker ì„¤ì¹˜..."
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    sudo usermod -aG docker $USER
    rm get-docker.sh
fi

# 3. Docker Compose ì„¤ì¹˜
echo "ðŸ³ Docker Compose ì„¤ì¹˜..."
if ! command -v docker-compose &> /dev/null; then
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# 4. ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì„¤ì • (t2.microìš©)
echo "ðŸ’¾ ìŠ¤ì™‘ ë©”ëª¨ë¦¬ ì„¤ì •..."
if [ ! -f /swapfile ]; then
    sudo fallocate -l 2G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
fi

# 5. ë°©í™”ë²½ ì„¤ì •
echo "ðŸ”’ ë°©í™”ë²½ ì„¤ì •..."
sudo ufw allow 22/tcp  # SSH
sudo ufw allow 8501/tcp  # Streamlit
sudo ufw --force enable

# 6. ì‹œê°„ëŒ€ ì„¤ì •
echo "ðŸ• ì‹œê°„ëŒ€ ì„¤ì •..."
sudo timedatectl set-timezone Asia/Seoul

# 7. ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •
echo "ðŸ“ ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •..."
sudo tee /etc/logrotate.d/quant-trading > /dev/null << EOF
/home/ubuntu/quant-trading/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 ubuntu ubuntu
}
EOF

echo "âœ… EC2 ì„¤ì • ì™„ë£Œ! ìž¬ë¡œê·¸ì¸ í•„ìš” (docker ê·¸ë£¹ ì ìš©)"

################################
# 4. scripts/ec2-deploy.sh (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸)
################################
#!/bin/bash
# EC2 ë°°í¬ ìžë™í™” ìŠ¤í¬ë¦½íŠ¸

set -e

# ì„¤ì •
REMOTE_USER="ubuntu"
REMOTE_HOST="your-ec2-public-ip"
KEY_PATH="~/.ssh/your-key.pem"
PROJECT_DIR="/home/ubuntu/quant-trading"

echo "ðŸš€ EC2 ë°°í¬ ì‹œìž‘..."

# 1. ì½”ë“œ ë™ê¸°í™”
echo "ðŸ“¦ ì½”ë“œ ì—…ë¡œë“œ..."
rsync -avz -e "ssh -i $KEY_PATH" \
    --exclude='.git' \
    --exclude='__pycache__' \
    --exclude='*.pyc' \
    --exclude='.env' \
    --exclude='logs/*' \
    --exclude='data/*' \
    ./ $REMOTE_USER@$REMOTE_HOST:$PROJECT_DIR/

# 2. ì›ê²© ëª…ë ¹ ì‹¤í–‰
echo "ðŸ”§ ì›ê²© ë°°í¬ ì‹¤í–‰..."
ssh -i $KEY_PATH $REMOTE_USER@$REMOTE_HOST << 'ENDSSH'
cd /home/ubuntu/quant-trading

# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
docker-compose down

# ì´ë¯¸ì§€ ë¹Œë“œ
docker-compose build

# ì»¨í…Œì´ë„ˆ ì‹œìž‘
docker-compose up -d

# í—¬ìŠ¤ì²´í¬
sleep 10
docker-compose ps
docker-compose logs --tail=50 quant-trading

echo "âœ… ë°°í¬ ì™„ë£Œ!"
ENDSSH

################################
# 5. systemd ì„œë¹„ìŠ¤ íŒŒì¼ (ì„ íƒì‚¬í•­)
################################
# /etc/systemd/system/quant-trading.service
[Unit]
Description=Quant Trading Docker Compose
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/ubuntu/quant-trading
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target

################################
# 6. CloudWatch ë¡œê¹… ì„¤ì • (ì„ íƒì‚¬í•­)
################################
# docker-compose.ymlì— ì¶”ê°€
services:
  quant-trading:
    logging:
      driver: awslogs
      options:
        awslogs-group: /ecs/quant-trading
        awslogs-region: ap-northeast-2
        awslogs-stream-prefix: quant

################################
# 7. EC2 User Data (ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ì‹œ)
################################
#!/bin/bash
# EC2 ì¸ìŠ¤í„´ìŠ¤ ì‹œìž‘ì‹œ ìžë™ ì‹¤í–‰

# Docker ì„¤ì¹˜
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
usermod -aG docker ubuntu

# Docker Compose ì„¤ì¹˜
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# Git ì„¤ì¹˜
apt-get update
apt-get install -y git

# í”„ë¡œì íŠ¸ í´ë¡ 
su - ubuntu -c "git clone https://github.com/your-repo/quant-trading.git /home/ubuntu/quant-trading"

# ì‹œìž‘
su - ubuntu -c "cd /home/ubuntu/quant-trading && docker-compose up -d"